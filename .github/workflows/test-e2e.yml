name: Test E2E

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  test-e2e:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: testuser
          POSTGRES_PASSWORD: testpass
          POSTGRES_DB: beststoree_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "22"
          cache: "npm"

      - name: Install dependencies
        run: |
          npm cache clean --force
          npm ci

      - name: Setup test database
        run: |
          # Migracje
          DATABASE_URL="postgresql://testuser:testpass@localhost:5432/beststoree_test" npx prisma migrate deploy
          DATABASE_URL="postgresql://testuser:testpass@localhost:5432/beststoree_test" npx prisma generate
        env:
          DATABASE_URL: postgresql://testuser:testpass@localhost:5432/beststoree_test

      - name: Build application
        run: npm run build
        env:
          DATABASE_URL: postgresql://testuser:testpass@localhost:5432/beststoree_test
          NODE_ENV: production
          NEXTAUTH_SECRET: test-secret-for-ci
          NEXTAUTH_URL: http://localhost:3000
          AUTH_SECRET: test-secret-for-ci
          AUTH_URL: http://localhost:3000
          AUTH_TRUST_HOST: true
          AUTH_COOKIE_NAME: authjs.session-token
          AUTH_COOKIE_SECURE: false
          AUTH_COOKIE_SAME_SITE: lax
          ENCRYPTION_KEY: ${{ secrets.ENCRYPTION_KEY || 'test-encryption-key-for-ci-minimum-32-chars' }}
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY || 're_test_key_for_ci' }}
          NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY: ${{ secrets.NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY || 'pk_test_placeholder' }}
          STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY || 'sk_test_placeholder' }}
          STRIPE_WEBHOOK_SECRET: ${{ secrets.STRIPE_WEBHOOK_SECRET || 'whsec_placeholder' }}
          PAYPAL_API_URL: ${{ secrets.PAYPAL_API_URL }}
          PAYPAL_CLIENT_ID: ${{ secrets.PAYPAL_CLIENT_ID }}
          PAYPAL_APP_SECRET: ${{ secrets.PAYPAL_APP_SECRET }}
          UPLOADTHING_TOKEN: ${{ secrets.UPLOADTHING_TOKEN }}
          UPLOADTHING_SECRET: ${{ secrets.UPLOADTHING_SECRET }}
          UPLOADTHING_APPID: ${{ secrets.UPLOADTHING_APPID }}

      - name: Copy public folder for standalone mode
        run: |
          cp -r public .next/standalone/public

      - name: Run E2E tests (Cypress)
        run: |
          npx start-server-and-test "PORT=3000 node .next/standalone/server.js" http://localhost:3000 cypress:run

        env:
          DATABASE_URL: postgresql://testuser:testpass@localhost:5432/beststoree_test
          NODE_ENV: production
          PORT: 3000
          NEXTAUTH_SECRET: test-secret-for-ci
          NEXTAUTH_URL: http://localhost:3000
          AUTH_SECRET: test-secret-for-ci
          AUTH_URL: http://localhost:3000
          AUTH_TRUST_HOST: true
          AUTH_COOKIE_NAME: authjs.session-token
          AUTH_COOKIE_SECURE: false
          AUTH_COOKIE_SAME_SITE: lax
          ENCRYPTION_KEY: ${{ secrets.ENCRYPTION_KEY || 'test-encryption-key-for-ci-minimum-32-chars' }}
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY || 're_test_key_for_ci' }}
          NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY: ${{ secrets.NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY || 'pk_test_placeholder' }}
          STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY || 'sk_test_placeholder' }}
          STRIPE_WEBHOOK_SECRET: ${{ secrets.STRIPE_WEBHOOK_SECRET || 'whsec_placeholder' }}
          PAYPAL_API_URL: ${{ secrets.PAYPAL_API_URL }}
          PAYPAL_CLIENT_ID: ${{ secrets.PAYPAL_CLIENT_ID }}
          PAYPAL_APP_SECRET: ${{ secrets.PAYPAL_APP_SECRET }}
          UPLOADTHING_TOKEN: ${{ secrets.UPLOADTHING_TOKEN }}
          UPLOADTHING_SECRET: ${{ secrets.UPLOADTHING_SECRET }}
          UPLOADTHING_APPID: ${{ secrets.UPLOADTHING_APPID }}
